<!DOCTYPE HTML>
<html>
<head>
    <title>TradingView Tools - Cugdeh</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <script type="text/javascript" src="./charting_library.standalone.js"></script>
    <script type="text/javascript" src="./bundle.js"></script>
    <link rel="stylesheet" href="./wrpskc.css?v=3">
</head>
<body style="margin:0;">
<div id="workspace">
    <div id="tv_chart_container"></div>
</div>
</body>
<script type="text/javascript">
    (function () {
        window.user = {
            host: "fxssi.com",
            id: 30747,
            name: "Try it FREE",
            "plan-pro": true,
            plan: "proplus",
            avatar: "https://fxssi.com/images/anonymous.png"
        };

        // ========= KONFIGURASI UTAMA CLIENT =========
        const CONFIG = {
            GITHUB_OWNER: "donnnfargooo8383",
            GITHUB_REPO: "tradingview-tools",
            GITHUB_BRANCH: "main",
            DATA_BASE_URL: "https://raw.githubusercontent.com/donnnfargooo8383/tradingview-tools/main/data",
            DEBUG_MODE: true
        };

        // ========= INDIKATOR CUSTOM (DIpertahankan) =========
        const __prorat_buy_sell__ = { /* ... definisi indikator ... */ };
        const __prorat_signal__ = { /* ... definisi indikator ... */ };
        // ... (semua definisi indikator dipertahankan) ...

        function initOnReady() {
            const widget = new TradingView.widget({
                fullscreen: true,
                symbol: getURLParameter('symbol') || 'EURUSD',
                interval: '20',
                container: "tv_chart_container",
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                datafeed: {
                    onReady: (callback) => {
                        callback({
                            supported_resolutions: ["15", "20", "30", "60", "240"],
                            supports_marks: true,
                            supports_search: true,
                            supports_time: true,
                            exchanges: [{ value: 'FXSSI', name: 'FXSSI', desc: 'FXSSI.com' }],
                            symbols_types: [
                                { name: 'crypto', value: 'crypto' },
                                { name: 'forex', value: 'forex' },
                                { name: 'index', value: 'index' }
                            ]
                        });
                    },
                    searchSymbols: (userInput, exchange, symbolType, onResultReadyCallback) => {
                        // ... (implementasi pencarian simbol tetap sama) ...
                    },
                    resolveSymbol: (symbolName, onSymbolResolvedCallback, onResolveErrorCallback, extension) => {
                        // ... (implementasi resolusi simbol tetap sama) ...
                    },
                    getBars: async function (symbolInfo, resolution, periodParams, onHistoryCallback, onErrorCallback) {
                        const symbol = symbolInfo.name;
                        const url = `${CONFIG.DATA_BASE_URL}/history/${symbol}_${resolution}.json`;
                        
                        try {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error('Data tidak ditemukan');
                            
                            const json = await response.json();
                            const bars = json.bars || [];
                            
                            // Simpan data buffer untuk indikator
                            if (!window.ssiBuffers) window.ssiBuffers = {};
                            for (const bar of bars) {
                                for (const key in bar) {
                                    if (!['time', 'open', 'high', 'low', 'close'].includes(key)) {
                                        if (!window.ssiBuffers[key]) window.ssiBuffers[key] = {};
                                        window.ssiBuffers[key][bar.time] = bar[key];
                                    }
                                }
                            }
                            
                            onHistoryCallback(bars, { noData: bars.length === 0 });
                        } catch (error) {
                            console.error(`Gagal memuat data: ${error}`);
                            onHistoryCallback([], { noData: true });
                        }
                    },
                    subscribeBars: () => {}, // Fungsi kosong (tidak diperlukan)
                    unsubscribeBars: () => {} // Fungsi kosong (tidak diperlukan)
                },
                locale: "en",
                custom_indicators_getter: function (PineJS) {
                    window.PineJS = PineJS;
                    return Promise.resolve([
                        __prorat_buy_sell__,
                        __prorat_signal__,
                        __prorat_delta__,
                        // ... (semua indikator custom) ...
                    ]);
                },
                disabled_features: ["header_compare", "header_screenshot", "header_saveload"]
            });

            // ========= FUNGSI BANTU =========
            function getURLParameter(name, url) {
                if (!url) url = window.location.href;
                name = name.replace(/[\[\]]/g, '\\$&');
                const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
                const results = regex.exec(url);
                if (!results) return null;
                if (!results[2]) return '';
                return decodeURIComponent(results[2].replace(/\+/g, ' '));
            }

            // ========= INISIALISASI HEATMAP (SLC) =========
            widget.onChartReady(() => {
                initHeatMap(widget);
            });

            function initHeatMap(widget) {
                const chart = widget.chart();
                let map = null;

                function createHeatMap() {
                    const symbol = chart.symbol();
                    const container = document.getElementById(widget._id).contentWindow.document;
                    
                    // Hapus heatmap lama jika ada
                    if (container.getElementById('slc')) {
                        container.getElementById('slc').remove();
                    }
                    
                    // Buat elemen heatmap baru
                    map = document.createElement('img');
                    map.id = 'slc';
                    map.style.cssText = `
                        position: absolute;
                        top: 0;
                        right: 0;
                        pointer-events: none;
                        mix-blend-mode: darken;
                        max-width: 300px;
                        display: none;
                    `;
                    
                    // Load gambar dari GitHub
                    map.src = `${CONFIG.DATA_BASE_URL}/heatmap/${symbol}.png`;
                    map.onload = () => {
                        map.style.display = 'block';
                        adjustHeatMapPosition();
                    };
                    
                    container.querySelector('.pane .chart-gui-wrapper').appendChild(map);
                }

                function adjustHeatMapPosition() {
                    if (!map) return;
                    
                    const priceScale = chart.getPanes()[0].getMainSourcePriceScale();
                    const priceRange = priceScale.getVisiblePriceRange();
                    const timeScale = chart.getTimeScale();
                    
                    if (!priceRange || !timeScale) return;
                    
                    // Hitung posisi berdasarkan skala harga dan waktu
                    const heightRatio = chart.getPanes()[0].getHeight() / (priceRange.to - priceRange.from);
                    const widthRatio = timeScale.width() / (timeScale.getVisibleRange().to - timeScale.getVisibleRange().from);
                    
                    map.style.top = `${(priceRange.to - widget.heatmap[symbol]?.prices[1]) * heightRatio}px`;
                    map.style.right = `${timeScale.rightOffset() * timeScale.barSpacing()}px`;
                }

                // Pemantau perubahan simbol
                chart.onSymbolChanged().subscribe(null, () => {
                    createHeatMap();
                });

                // Pemantau perubahan skala
                const monitorScale = () => {
                    adjustHeatMapPosition();
                    setTimeout(monitorScale, 1000);
                };
                monitorScale();
                
                // Tombol toggle heatmap
                widget.headerReady().then(() => {
                    const button = widget.createButton();
                    button.textContent = 'SLC';
                    button.classList.add('ssi-toggle', 'active');
                    button.addEventListener('click', () => {
                        button.classList.toggle('active');
                        if (map) map.style.display = button.classList.contains('active') ? 'block' : 'none';
                    });
                });

                createHeatMap();
            }
        }

        window.addEventListener('DOMContentLoaded', initOnReady, false);
    })();
</script>
</html>
