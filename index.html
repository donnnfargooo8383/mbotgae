<!DOCTYPE HTML>
<html>
<head>
    <title>TradingView Tools - Cugdeh</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <script type="text/javascript" src="./charting_library.standalone.js"></script>
    <link rel="stylesheet" href="./wrpskc.css?v=3">
</head>
<body style="margin:0;">
<div id="workspace" class="o p">
    <div id="tv_chart_container"></div>
    <div id="right_panel" class="_loading">
        <div class="toolbar">
            <div class="suspended-message">Loading...</div>
        </div>
        <div class="books"></div>
    </div>
</div>
<script type="text/javascript">
    (function() {
        // Datafeed implementation
        const datafeed = {
            onReady: (callback) => {
                callback({
                    supported_resolutions: ["15", "20", "30", "60", "240"],
                    supports_marks: true,
                    supports_search: true,
                    supports_time: true,
                    exchanges: [{value: 'FXSSI', name: 'FXSSI', desc: 'FXSSI.com'}],
                    symbols_types: [
                        {name: 'crypto', value: 'crypto'},
                        {name: 'forex', value: 'forex'},
                        {name: 'index', value: 'index'},
                    ]
                });
            },
            
            searchSymbols: (userInput, exchange, symbolType, onResultReadyCallback) => {
                const symbols = {
                    crypto: ["BTCUSD", "ETHUSD"],
                    forex: [
                        "EURUSD", "XAUUSD", "EURGBP", "AUDJPY", "AUDUSD", 
                        "EURAUD", "EURCHF", "EURJPY", "GBPCHF", "GBPJPY",
                        "GBPUSD", "NZDUSD", "USDCAD", "USDCHF", "USDJPY", 
                        "XAGUSD", "XTIUSD"
                    ],
                    index: ["US30", "NAS100"]
                };
                
                const foundSymbols = symbols[symbolType] || [...symbols.crypto, ...symbols.forex];
                const filtered = foundSymbols.filter(s => 
                    s.toLowerCase().includes(userInput.toLowerCase())
                );
                
                onResultReadyCallback(filtered.map(symbol => ({
                    symbol,
                    ticker: symbol,
                    description: symbol,
                    exchange: "FXSSI",
                    type: symbolType
                })));
            },
            
            resolveSymbol: (symbolName, onSymbolResolvedCallback) => {
                let type = "forex";
                if (['ETHUSD', 'BTCUSD'].includes(symbolName)) type = 'crypto';
                if (['US30', 'NAS100'].includes(symbolName)) type = 'index';
                
                let session = "2200-2200";
                if (type === 'crypto') session = '24x7';
                if (symbolName === "XTIUSD") session = '2200-2100';

                onSymbolResolvedCallback({
                    name: symbolName,
                    ticker: symbolName,
                    description: symbolName,
                    type,
                    session,
                    exchange: "FXSSI",
                    minmovement: 1,
                    pricescale: 10000,
                    pointvalue: 100,
                    minmovement2: 100,
                    fractional: false,
                    has_intraday: true,
                    has_seconds: false,
                    has_daily: true,
                    has_weekly_and_monthly: true,
                    has_empty_bars: true,
                    force_session_rebuild: true,
                    visible_plots_set: "ohlc",
                    volume_precision: 1,
                    data_status: "streaming"
                });
            },
        
            getBars: async function(symbolInfo, resolution, periodParams, onHistoryCallback) {
              const url = `/api/data?type=history&symbol=${symbolInfo.name}&timeframe=${resolution}`;
              
              try {
                const response = await fetch(url);
                if (response.ok) {
                  const data = await response.json();
                  console.log('Data received:', data); // Log untuk debugging
                  onHistoryCallback(data.bars || []);
                } else {
                  console.error('API error:', response.status);
                  onHistoryCallback([], { noData: true });
                }
              } catch (e) {
                console.error('Fetch error:', e);
                onHistoryCallback([], { noData: true });
              }
            },
        };

        // Heatmap implementation
        function initHeatMap(widget) {
            const chart = widget.chart();
            let map, xRatio;
            let symbol = chart.symbol();

            chart.onSymbolChanged().subscribe(null, () => {
                symbol = chart.symbol();
                if (map) map.remove();
                tryHeatmap();
            });

            function adjustHeatmap() {
                if (!map || !widget.heatmap[symbol]) return;
                
                const scale = chart.getTimeScale();
                const series = chart.getSeries();
                
                if (!series) return;
                
                const lastBar = series.data().m_bars._end - 1;
                const lastBarTime = series.data().m_bars._items[lastBar].timeMs / 1000;
                const timeDiff = lastBarTime - widget.heatmap[symbol].times[1];
                
                const mapWidth = widget.heatmap[symbol]['image-resolution'][0] * widget.heatmap[symbol]['resolution'];
                const pane = chart.getPanes()[0];
                const priceRange = pane.getMainSourcePriceScale().getVisiblePriceRange();
                const yRatio = pane.getHeight() / (priceRange.to - priceRange.from);
                
                map.style.width = `${mapWidth * xRatio}px`;
                map.style.height = `${widget.heatmap[symbol]['image-resolution'][1] * yRatio}px`;
                map.style.right = `${(scale.rightOffset() * scale.barSpacing()) + timeDiff * xRatio}px`;
                map.style.top = `${(priceRange.to - widget.heatmap[symbol].prices[1] - widget.heatmap[symbol].step) * yRatio}px`;
            }

            function tryHeatmap() {
                setTimeout(() => {
                    if (!createHeatMap()) tryHeatmap();
                }, 500);
            }

            function createHeatMap() {
                if (!chart.getSeries()) return false;
                
                symbol = chart.symbol();
                map = document.createElement("img");
                map.id = "slc";
                map.style.cssText = `
                    position: absolute;
                    top: 0;
                    right: 0;
                    cursor: pointer;
                    pointer-events: none;
                    mix-blend-mode: darken;
                    width: 300px;
                `;
                
                map.src = `/api/data?type=heatmap&symbol=${symbol}`;
                document.querySelector(".chart-gui-wrapper").appendChild(map);
                return true;
            }

            widget.headerReady().then(() => {
                const button = widget.createButton();
                button.classList.add('ssi-toggle', 'active');
                button.textContent = 'SLC';
                button.addEventListener('click', () => {
                    button.classList.toggle('active');
                    map.style.visibility = button.classList.contains('active') ? 'visible' : 'hidden';
                });
            });
        }

        // Main initialization
        function initOnReady() {
            const widget = new TradingView.widget({
                fullscreen: true,
                symbol: new URLSearchParams(window.location.search).get('symbol') || 'XAUUSD',
                interval: '20',
                container: "tv_chart_container",
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                datafeed: datafeed,
                locale: "en",
                disabled_features: ["header_compare", "header_screenshot", "header_saveload"],
                custom_indicators_getter: function(PineJS) {
                    return Promise.resolve([]); // Add custom indicators if needed
                }
            });
            
            widget.heatmap = {};
            widget.onChartReady(() => {
                initHeatMap(widget);
                
                // Create indicators dropdown
                widget.createDropdown({
                    title: 'FXSSI Indicators',
                    icon: '<svg>...</svg>',
                    items: [
                        { title: 'ProfitRatio (BUY:SELL)', onSelect: () => {} },
                        { title: 'ProfitRatio (Signal)', onSelect: () => {} },
                        // Add other indicators...
                    ]
                });
            });
        }

        window.addEventListener('DOMContentLoaded', initOnReady, false);
    })();
</script>
</body>
</html>
