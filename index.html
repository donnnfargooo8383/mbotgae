<!DOCTYPE HTML>
<html>
<head>
    <title>taneceg</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <script type="text/javascript" src="./charting_library.standalone.js"></script>
    <script type="text/javascript" src="./bundle.js"></script>
    <link rel="stylesheet" href="./wrpskc.css?v=3">
</head>
<body style="margin:0;">
    <div id="tv_chart_container"></div>
</body>
<script type="text/javascript">
    (function() {
        // [Kode indikator dan studi tetap sama] //
        
        function initOnReady() {
            const widget = new TradingView.widget({
                // ... [Konfigurasi widget tetap sama] ... //
                // library_path: "https://charting-library.tradingview-widget.com/charting_library/",
                // debug: true, // uncomment this line to see Library errors and warnings in the console
                fullscreen: true,
                symbol: getURLParameter('symbol') ?? 'XAUUSD',
                interval: '20',
                // load_last_chart: true,
                // user_id: 1, // IMPORTANT!
                custom_css_url: "/tradingview-tools/tv.css?v=2",
                container: "tv_chart_container",
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                save_load_adapter: {
                    getAllCharts: function () {
                        console.log("getAllCharts");
                        return Promise.resolve({id: "main_chart", name: "main_chart", resolution: "15M", symbol: "XAUUSD"});
                    }
                },
                // datafeed: new Datafeeds.UDFCompatibleDatafeed("/tv", 20000), // 10 seconds
                datafeed: {
                    // ... [Konfigurasi datafeed] ... //
                    onReady: (callback) => {
                        console.log('[onReady]: Method call');

                        callback({
                            // Represents the resolutions for bars supported by your datafeed
                            supported_resolutions: [
                                // "5",
                                "15",
                                "20",
                                "30",
                                "60",
                                "240",
                            ],
                            supports_marks: true,
                            supports_search: true,
                            supports_time: true,
                            // The `exchanges` arguments are used for the `searchSymbols` method if a user selects the exchange
                            exchanges: [
                                {value: 'FXSSI', name: 'FXSSI', desc: 'FXSSI.com'},
                                // {value: 'Kraken', name: 'Kraken', desc: 'Kraken bitcoin exchange'},
                            ],
                            // The `symbols_types` arguments are used for the `searchSymbols` method if a user selects this symbol type
                            symbols_types: [
                                {name: 'crypto', value: 'crypto'},
                                {name: 'forex', value: 'forex'},
                                {name: 'index', value: 'index'},
                            ]
                        });
                    },
                    
                    searchSymbols: (userInput, exchange, symbolType, onResultReadyCallback) => {
                        let symbols;
                        const crypto = [
                            "BTCUSD",
                            "ETHUSD",
                        ];
                        const forex = [
                            "EURUSD",
                            "XAUUSD",
                            "EURGBP",
                            "AUDJPY",
                            "AUDUSD",
                            "EURAUD",
                            "EURCHF",
                            "EURJPY",
                            "GBPCHF",
                            "GBPJPY",
                            "GBPUSD",
                            "NZDUSD",
                            "USDCAD",
                            "USDCHF",
                            "USDJPY",
                            "XAGUSD",
                            "XTIUSD"
                        ];
                        const indexes = [
                            "US30",
                            "NAS100"
                        ];
                        if (symbolType === 'crypto')
                            symbols = crypto;
                        else if (symbolType === 'forex')
                            symbols = forex;
                        else if (symbolType === 'index')
                            symbols = indexes;
                        else
                            symbols = crypto.concat(forex);

                        let ret = [];
                        let found_symbols = [];
                        for (let symbol of symbols) {
                            if (['ETHUSD', 'BTCUSD'].indexOf(symbol) > -1) symbolType = 'crypto';
                            if (['US30', 'NAS100'].indexOf(symbol) > -1) symbolType = 'index';
                            if (symbol.toLowerCase().indexOf(userInput.toLowerCase()) < 0) continue;
                            found_symbols.push(symbol);
                        }
                        symbols = found_symbols.concat(symbols);
                        symbols = symbols.filter((value, index, array) => array.indexOf(value) === index);

                        for (let symbol of symbols) {
                            // type = "forex";
                            ret.push({
                                "symbol": symbol,
                                "ticker": symbol,
                                // "full_name": symbol,
                                "description": symbol,
                                "exchange": "FXSSI",
                                "type": symbolType
                            });
                        }

                        onResultReadyCallback(ret);
                    },
                    
                    resolveSymbol: (symbolName, onSymbolResolvedCallback, onResolveErrorCallback, extension) => {
                        // console.log('[resolveSymbol]: Method call', symbolName);
                        let type = "forex";
                        if (['ETHUSD', 'BTCUSD'].indexOf(symbolName) > -1) type = 'crypto';
                        if (['US30', 'NAS100'].indexOf(symbolName) > -1) type = 'index';
                        let session = "2200-2200";
                        if (type === 'crypto') session = '24x7';
                        if (symbolName === "XTIUSD") session = '2200-2100';

                        const config = {
                            "name": symbolName,
                            "ticker": symbolName,
                            "description": symbolName,
                            "type": type,
                            "session": session,
                            "exchange": "FXSSI",
                            "listed_exchange": "",
                            "minmovement": 1,
                            "pricescale": 10000,
                            "pointvalue": 100,
                            "minmovement2": 100,
                            "fractional": false,
                            // "suported_resolutions": [
                            //     "5",
                            //     "15",
                            //     "30",
                            //     "60",
                            //     "240",
                            // ],
                            "has_intraday": true,
                            // "intraday_multipliers": [
                            //     "5",
                            //     "15",
                            //     "30",
                            //     "60",
                            //     "240",
                            // ],
                            "has_seconds": false,
                            "seconds_multipliers": [],
                            "has_daily": true,
                            "has_weekly_and_monthly": true,
                            "has_empty_bars": true,
                            "force_session_rebuild": true,
                            "visible_plots_set": "ohlc",
                            "volume_precision": 1,
                            "data_status": "streaming",
                            "expired": false,
                            "sector": "",
                            "industry": ""
            //                    "currency_code": "EURUSD"
                        }

                        // console.log(config);
                        onSymbolResolvedCallback(config);
                    },
                                        
                    getBars: async function(symbolInfo, resolution, periodParams, onHistoryCallback) {
                        const symbol = symbolInfo.name;
                        const res = resolution;
                        const url = `https://raw.githubusercontent.com/donnnfargooo8383/tradingview-tools/main/data/history/${symbol}_${res}.json`;
                        
                        try {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error('Data not found');
                            
                            const data = await response.json();
                            const bars = data.bars || [];
                            
                            // Proses data bars
                            if (bars.length > 0) {
                                // Simpan buffer untuk indikator
                                if (!window.ssiBuffers) window.ssiBuffers = {};
                                bars.forEach(bar => {
                                    for (const key in bar) {
                                        if (!['time', 'open', 'high', 'low', 'close'].includes(key)) {
                                            if (!window.ssiBuffers[key]) window.ssiBuffers[key] = {};
                                            window.ssiBuffers[key][bar.time] = bar[key];
                                        }
                                    }
                                });
                                onHistoryCallback(bars, { noData: false });
                            } else {
                                onHistoryCallback([], { noData: true });
                            }
                        } catch (error) {
                            console.error(`Error loading data: ${error}`);
                            onHistoryCallback([], { noData: true });
                        }
                    },
                    
                    // ... [Fungsi lainnya tetap] ... //
                }
            });

            // Inisialisasi Heatmap
            function initHeatMap() {
                widget.onChartReady(() => {
                    const chart = widget.chart();
                    const symbol = chart.symbol();
                    const url = `https://raw.githubusercontent.com/donnnfargooo8383/tradingview-tools/main/data/heatmap/${symbol}.png`;
                    
                    // Buat elemen gambar heatmap
                    const heatmapImg = document.createElement('img');
                    heatmapImg.id = 'heatmap-overlay';
                    heatmapImg.src = url;
                    heatmapImg.style.position = 'absolute';
                    heatmapImg.style.zIndex = '5';
                    heatmapImg.style.pointerEvents = 'none';
                    heatmapImg.style.opacity = '0.7';
                    
                    // Tambahkan ke container chart
                    const container = document.getElementById(widget._id).contentDocument
                        .querySelector('.chart-gui-wrapper');
                    container.appendChild(heatmapImg);
                    
                    // Fungsi penyesuaian posisi
                    function adjustHeatmap() {
                        const priceScale = chart.getPanes()[0].getMainSourcePriceScale();
                        const range = priceScale.getVisiblePriceRange();
                        
                        // Hitung posisi berdasarkan range harga
                        const height = container.clientHeight;
                        const priceRange = range.to - range.from;
                        const top = ((range.to - currentPrice) / priceRange) * height;
                        
                        // Atur posisi gambar
                        heatmapImg.style.top = `${top}px`;
                        heatmapImg.style.left = '0';
                        heatmapImg.style.width = '100%';
                    }
                    
                    // Update saat simbol atau range berubah
                    chart.onSymbolChanged().subscribe(null, adjustHeatmap);
                    chart.onVisibleRangeChanged().subscribe(null, adjustHeatmap);
                });
            }
            
            initHeatMap();
        }

        window.addEventListener('DOMContentLoaded', initOnReady);
    })();
</script>
</html>
