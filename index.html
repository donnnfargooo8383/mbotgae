<!DOCTYPE HTML>
<html>
<head>
    <title>TradingView Tools - FXSSI</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <script type="text/javascript" src="./charting_library.standalone.js"></script>
    <script type="text/javascript" src="./bundle.js"></script>
    <link rel="stylesheet" href="./wrpskc.css?v=3">
    <style>
        /* Styling tambahan untuk indikator loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-size: 20px;
            flex-direction: column;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body style="margin:0;">
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div>Memuat data dari iwir iwir...</div>
    </div>
    
    <div id="workspace" class="with-book o p">
        <div id="tv_chart_container"></div>
        <div id="right_panel" class="_loading">
            <div class="toolbar">
                <div class="op-toggle toolbar-btn o p">
                    Orders + Positions
                </div>
                <div class="net-toggle toolbar-btn">
                    All
                </div>
            </div>
            <div class="books"></div>
            <div class="suspended-message">suspended...</div>
            <div class="suspended-overlay"></div>
            <div class="price-line"></div>
            <div class="book-price-line"></div>
        </div>
    </div>
    
    <script type="text/javascript">
        (function () {
            // Konfigurasi GitHub
            const GITHUB_OWNER = "donnnfargooo8383";
            const GITHUB_REPO = "mbotgae";
            const GITHUB_BRANCH = "main";
            
            // URL dasar untuk data di GitHub
            const GITHUB_DATA_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/data`;
            
            // Variabel untuk menyimpan data dari GitHub
            window.githubData = {
                history: {},
                heatmap: {}
            };
            
            // Menampilkan/menyembunyikan loading overlay
            function showLoading(show) {
                document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
            }
            
            // Fungsi untuk mengambil data dari GitHub
            async function fetchFromGitHub(path) {
                try {
                    const url = `${GITHUB_DATA_BASE_URL}/${path}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`Gagal mengambil data: ${response.status}`);
                    }
                    
                    // Handle JSON vs binary data
                    if (path.endsWith('.json')) {
                        return await response.json();
                    } else {
                        return await response.blob();
                    }
                } catch (error) {
                    console.error(`Error mengambil data dari GitHub: ${error.message}`);
                    return null;
                }
            }
            
            // Fungsi untuk mengambil data history
            async function loadHistoryData(symbol, resolution) {
                const cacheKey = `${symbol}_${resolution}`;
                
                // Gunakan data cache jika tersedia
                if (window.githubData.history[cacheKey]) {
                    return window.githubData.history[cacheKey];
                }
                
                showLoading(true);
                const path = `history/${symbol}_${resolution}.json`;
                const data = await fetchFromGitHub(path);
                
                if (data) {
                    window.githubData.history[cacheKey] = data;
                    console.log(`Data history ${symbol} ${resolution}m berhasil dimuat`);
                }
                
                showLoading(false);
                return data;
            }
            
            // Fungsi untuk mengambil heatmap
            async function loadHeatmapData(symbol) {
                // Gunakan data cache jika tersedia
                if (window.githubData.heatmap[symbol]) {
                    return window.githubData.heatmap[symbol];
                }
                
                showLoading(true);
                const path = `heatmap/${symbol}.png`;
                const blob = await fetchFromGitHub(path);
                
                if (blob) {
                    // Konversi blob ke URL objek
                    const url = URL.createObjectURL(blob);
                    window.githubData.heatmap[symbol] = url;
                    console.log(`Heatmap ${symbol} berhasil dimuat`);
                }
                
                showLoading(false);
                return window.githubData.heatmap[symbol];
            }

            window.user = {"host":"fxssi.com","id":30747,"name":"Try it FREE","plan-pro":true,"plan":"proplus","avatar":"https:\/\/fxssi.com\/images\/anonymous.png"};
            
            // ======== DEFINISI INDIKATOR CUSTOM ========
            // (Tetap sama seperti versi sebelumnya)
            // ... [kode untuk __prorat_buy_sell__ dan indikator lainnya] ...
            
            function initOnReady() {
                // ======== INISIALISASI CHART ========
                const widget = new TradingView.widget({
                    fullscreen: true,
                    symbol: getURLParameter('symbol') ?? 'EURUSD',
                    interval: '20',
                    container: "tv_chart_container",
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    save_load_adapter: {
                        getAllCharts: function () {
                            return Promise.resolve({id: "main_chart", name: "main_chart", resolution: "15M", symbol: "EURUSD"});
                        }
                    },
                    datafeed: {
                        onReady: (callback) => {
                            callback({
                                supported_resolutions: ["15", "20", "30", "60", "240"],
                                supports_marks: true,
                                supports_search: true,
                                supports_time: true,
                                exchanges: [
                                    {value: 'FXSSI', name: 'FXSSI', desc: 'FXSSI.com'},
                                ],
                                symbols_types: [
                                    {name: 'crypto', value: 'crypto'},
                                    {name: 'forex', value: 'forex'},
                                    {name: 'index', value: 'index'},
                                ]
                            });
                        },
                        searchSymbols: (userInput, exchange, symbolType, onResultReadyCallback) => {
                            let symbols;
                            const crypto = [
                                "BTCUSD",
                                "ETHUSD",
                            ];
                            const forex = [
                                "EURUSD",
                                "XAUUSD",
                                "EURGBP",
                                "AUDJPY",
                                "AUDUSD",
                                "EURAUD",
                                "EURCHF",
                                "EURJPY",
                                "GBPCHF",
                                "GBPJPY",
                                "GBPUSD",
                                "NZDUSD",
                                "USDCAD",
                                "USDCHF",
                                "USDJPY",
                                "XAGUSD",
                                "XTIUSD"
                            ];
                            const indexes = [
                                "US30",
                                "NAS100"
                            ];
                            if (symbolType === 'crypto')
                                symbols = crypto;
                            else if (symbolType === 'forex')
                                symbols = forex;
                            else if (symbolType === 'index')
                                symbols = indexes;
                            else
                                symbols = crypto.concat(forex);

                            let ret = [];
                            let found_symbols = [];
                            for (let symbol of symbols) {
                                if (['ETHUSD', 'BTCUSD'].indexOf(symbol) > -1) symbolType = 'crypto';
                                if (['US30', 'NAS100'].indexOf(symbol) > -1) symbolType = 'index';
                                if (symbol.toLowerCase().indexOf(userInput.toLowerCase()) < 0) continue;
                                found_symbols.push(symbol);
                            }
                            symbols = found_symbols.concat(symbols);
                            symbols = symbols.filter((value, index, array) => array.indexOf(value) === index);

                            for (let symbol of symbols) {
                                // type = "forex";
                                ret.push({
                                    "symbol": symbol,
                                    "ticker": symbol,
                                    // "full_name": symbol,
                                    "description": symbol,
                                    "exchange": "FXSSI",
                                    "type": symbolType
                                });
                            }

                            onResultReadyCallback(ret);
                        },
                        resolveSymbol: (symbolName, onSymbolResolvedCallback, onResolveErrorCallback, extension) => {
                            // console.log('[resolveSymbol]: Method call', symbolName);
                            let type = "forex";
                            if (['ETHUSD', 'BTCUSD'].indexOf(symbolName) > -1) type = 'crypto';
                            if (['US30', 'NAS100'].indexOf(symbolName) > -1) type = 'index';
                            let session = "2200-2200";
                            if (type === 'crypto') session = '24x7';
                            if (symbolName === "XTIUSD") session = '2200-2100';

                            const config = {
                                "name": symbolName,
                                "ticker": symbolName,
                                "description": symbolName,
                                "type": type,
                                "session": session,
                                "exchange": "FXSSI",
                                "listed_exchange": "",
                                "minmovement": 1,
                                "pricescale": 10000,
                                "pointvalue": 100,
                                "minmovement2": 100,
                                "fractional": false,
                                // "suported_resolutions": [
                                //     "5",
                                //     "15",
                                //     "30",
                                //     "60",
                                //     "240",
                                // ],
                                "has_intraday": true,
                                // "intraday_multipliers": [
                                //     "5",
                                //     "15",
                                //     "30",
                                //     "60",
                                //     "240",
                                // ],
                                "has_seconds": false,
                                "seconds_multipliers": [],
                                "has_daily": true,
                                "has_weekly_and_monthly": true,
                                "has_empty_bars": true,
                                "force_session_rebuild": true,
                                "visible_plots_set": "ohlc",
                                "volume_precision": 1,
                                "data_status": "streaming",
                                "expired": false,
                                "sector": "",
                                "industry": ""
                //                    "currency_code": "EURUSD"
                            }

                            // console.log(config);
                            onSymbolResolvedCallback(config);
                        },
                        
                        
                        getBars: async function (symbolInfo, resolution, periodParams, onHistoryCallback, onErrorCallback) {
                            const symbol = symbolInfo.name;
                            
                            // Ambil data history dari GitHub
                            const historyData = await loadHistoryData(symbol, resolution);
                            
                            if (!historyData) {
                                onErrorCallback("Gagal memuat data history");
                                return;
                            }
                            
                            // Proses data untuk TradingView
                            const bars = historyData.bars || [];
                            
                            // Simpan data tambahan untuk indikator custom
                            if (!window.ssiBuffers) window.ssiBuffers = {};
                            
                            for (let bar of bars) {
                                for (let key in bar) {
                                    if (['time', 'open', 'low', 'high', 'close'].indexOf(key) < 0) {
                                        if (!window.ssiBuffers[key]) window.ssiBuffers[key] = {};
                                        window.ssiBuffers[key][bar['time']] = bar[key];
                                    }
                                }
                            }
                            
                            // Kirim data ke chart
                            if (periodParams.countBack > bars.length) {
                                onHistoryCallback([], { noData: true });
                            } else {
                                onHistoryCallback(bars);
                            }
                        },
                        subscribeBars: (symbolInfo, resolution, onRealtimeCallback, subscriberUID, onResetCacheNeededCallback) => {
                            // Nonaktifkan real-time untuk versi GitHub
                        },
                        unsubscribeBars: (subscriberUID) => {
                            // Nonaktifkan unsubscribe untuk versi GitHub
                        },
                    },
                    locale: "en",
                    disabled_features: ["header_compare", "header_screenshot", "header_saveload"],
                    enabled_features: [],
                    custom_indicators_getter: function (_PineJS) {
                        window.PineJS = _PineJS;
                        return Promise.resolve([
                            __prorat_buy_sell__, __prorat_signal__, __prorat_delta__,
                            __interest_orders__, __interest_orders_delta__, __interest_positions__, __interest_positions_delta__,
                            __activity_increase__, __activity_increase_delta__, __activity_decrease__, __activity_decrease_delta__,
                            __ratios__, __derivatives__])
                    }
                });

                // ======== FUNGSI HEATMAP ========
                async function initHeatMap() {
                    const chart = widget.chart(), interval = 10;
                    let priceTo, priceFrom, paneHeight, paneWidth, timeTo, timeFrom, map, xRatio;
                    let symbol = chart.symbol();
                    let enabled = true;

                    chart.onSymbolChanged().subscribe(null, () => {
                        symbol = chart.symbol();
                        if (map) map.remove();
                        tryHeatmap();
                    });

                    function adjustHeatmap() {
                        if (!map || !window.githubData.heatmap[symbol]) return;
                        
                        map.style.display = 'block';
                        const scale = chart.getTimeScale();
                        const yRatio = paneHeight / (priceTo - priceFrom);
                        
                        // Atur posisi dan ukuran heatmap
                        map.style.width = "300px";
                        map.style.position = "absolute";
                        map.style.top = "0";
                        map.style.right = "0";
                    }

                    async function tryHeatmap() {
                        if (!chart.getSeries()) {
                            setTimeout(tryHeatmap, 500);
                            return;
                        }
                        
                        symbol = chart.symbol();
                        
                        // Ambil heatmap dari GitHub
                        const heatmapUrl = await loadHeatmapData(symbol);
                        if (!heatmapUrl) return;
                        
                        // Buat elemen gambar untuk heatmap
                        map = document.createElement("img");
                        map.id = "slc";
                        map.style.width = "300px";
                        map.style.position = "absolute";
                        map.style.top = "0";
                        map.style.right = "0";
                        map.style.cursor = 'pointer';
                        map.style.pointerEvents = 'none';
                        map.style.mixBlendMode = 'darken';
                        map.src = heatmapUrl;
                        
                        // Tambahkan ke chart
                        const chartContainer = document.getElementById(widget._id).contentWindow.document.querySelector(".pane .chart-gui-wrapper");
                        if (chartContainer) {
                            chartContainer.appendChild(map);
                            adjustHeatmap();
                        }
                    }

                    function monitorPriceScale() {
                        const panes = chart.getPanes();

                        if (!panes) return;
                        const pane = panes[0];
                        try {
                            const scale = pane?.getMainSourcePriceScale();
                            const range = scale?.getVisiblePriceRange();
                            if (range) {
                                const pRange = range.to - range.from;
                                if (priceRange !== pRange || priceTo !== range.to) {
                                    paneHeight = pane.getHeight();
                                    priceTo = range.to;
                                    priceRange = pRange;
                                    yRatio = paneHeight / priceRange;

                                    if (!obook || !pbook) tryCreateBook();


                                    adjustBook();
                                }
                            }
                        } catch (e) {
                            // console.error(e);
                        }

                        setTimeout(monitorPriceScale, interval);
                    }

                    widget.headerReady().then(function () {
                        if (!('__slc_button' in window)) {
                            __slc_button = widget.createButton();
                            __slc_button.classList.add('ssi-toggle', 'active');
                            __slc_button.addEventListener('click', function () {
                                __slc_button.classList.toggle('active');
                                enabled = __slc_button.classList.contains('active');
                                if (map) map.style.visibility = enabled ? 'visible' : 'hidden';
                            });
                            __slc_button.textContent = 'SLC';
                        }
                    });

                    setTimeout(monitorPriceScale, interval);
                    tryHeatmap();
                }

                // ======== FUNGSI TAMBAHAN ========
                function getURLParameter(name, url) {
                    if (!url) url = location.href;
                    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
                    var regexS = "[\\?&]" + name + "=([^&#]*)";
                    var regex = new RegExp(regexS);
                    var results = regex.exec(url);
                    return results == null ? undefined : results[1];
                }

                widget.headerReady().then(function () {
                    const button = widget.createButton();
                    button.classList.add('ssi-toggle', 'active');
                    button.addEventListener('click', function () {
                        button.classList.toggle('active');
                        widget.bookEnabled = button.classList.contains('active');
                        document.getElementById('workspace').classList.toggle('with-book', widget.bookEnabled);
                    });
                    button.textContent = 'OrderBook';
                });

                widget.onChartReady(function () {
                    initHeatMap();
                    console.log("Chart Ready");
                    
                    // Atur event handler saat simbol berubah
                    widget.activeChart().onSymbolChanged().subscribe(null, () => {
                        const urlParams = new URLSearchParams(window.location.search);
                        urlParams.set('symbol', widget.activeChart().symbol());
                        window.history.replaceState({}, '', `${window.location.pathname}?${urlParams}`);
                    });
                });
            }

            window.addEventListener('DOMContentLoaded', initOnReady, false);
        })();
    </script>
</body>
</html>
