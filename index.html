<!DOCTYPE HTML>
<html>
<head>
    <title>cugdeh</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <script type="text/javascript" src="./charting_library.standalone.js"></script>
    <script type="text/javascript" src="./bundle.js"></script>
    <link rel="stylesheet" href="./wrpskc.css?v=3">
</head>
<body style="margin:0;">
    <div id="tv_chart_container"></div>
</body>
<script type="text/javascript">
    (function () {        
        // ========= KONFIGURASI UTAMA =========
        const GITHUB_OWNER = "donnnfargooo8383";
        const GITHUB_REPO = "mbotgae";
        const GITHUB_BRANCH = "main";
        const BASE_URL = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}`;

        function initOnReady() {
            const widget = new TradingView.widget({
                fullscreen: true,
                symbol: getURLParameter('symbol') || 'XAUUSD',
                interval: '20',
                container: "tv_chart_container",
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                datafeed: {
                    onReady: (callback) => {
                        console.log('Datafeed ready');
                        callback({
                            supported_resolutions: ["15", "20", "30", "60", "240"],
                            supports_marks: true,
                            supports_search: true,
                            supports_time: true,
                            exchanges: [{value: 'SAWO', name: 'SAWO', desc: 't.me'}],
                            symbols_types: [
                                {name: 'crypto', value: 'crypto'},
                                {name: 'forex', value: 'forex'},
                                {name: 'index', value: 'index'},
                            ]
                        });
                    },                    
                    searchSymbols: (userInput, exchange, symbolType, onResultReadyCallback) => {
                        console.log('Searching symbols:', userInput);
                        const symbols = ["XAUUSD", "BTCUSD"];
                        const ret = symbols
                            .filter(symbol => symbol.toLowerCase().includes(userInput.toLowerCase()))
                            .map(symbol => ({
                                symbol,
                                ticker: symbol,
                                description: symbol,
                                exchange: "SAWO",
                                type: symbol === "BTCUSD" ? 'crypto' : 'forex'
                            }));
                        onResultReadyCallback(ret);
                    },
                    
                    resolveSymbol: (symbolName, onSymbolResolvedCallback, onResolveErrorCallback, extension) => {
                        console.log('Resolving symbol:', symbolName);
                        const config = {
                            name: symbolName,
                            ticker: symbolName,
                            description: symbolName,
                            type: symbolName === "BTCUSD" ? 'crypto' : 'forex',
                            session: "2200-2200",
                            exchange: "SAWO",
                            listed_exchange: "",
                            minmovement: 1,
                            pricescale: 10000,
                            pointvalue: 100,
                            minmovement2: 100,
                            fractional: false,
                            has_intraday: true,
                            has_seconds: false,
                            seconds_multipliers: [],
                            has_daily: true,
                            has_weekly_and_monthly: true,
                            has_empty_bars: true,
                            force_session_rebuild: true,
                            visible_plots_set: "ohlc",
                            volume_precision: 1,
                            data_status: "streaming",
                            expired: false,
                            sector: "",
                            industry: ""
                        };
                        onSymbolResolvedCallback(config);
                    },
                                                                 
                    getBars: async function (symbolInfo, resolution, periodParams, onHistoryCallback, onErrorCallback) {
                        const symbol = symbolInfo.name;
                        console.log(`Loading bars for ${symbol} (${resolution})`);
                        
                        const url = `${BASE_URL}/data/history/${symbol}_${resolution}.json`;
                        console.log('Fetching data from:', url);
                        
                        try {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            
                            const json = await response.json();
                            console.log(`Loaded ${json.bars.length} bars for ${symbol}`);
                            
                            // Simpan data ke cache sederhana
                            if (!window.chartDataCache) window.chartDataCache = {};
                            window.chartDataCache[`${symbol}_${resolution}`] = json;
                            
                            // Simpan buffer untuk indikator
                            if (!window.ssiBuffers) window.ssiBuffers = {};
                            json.bars.forEach(bar => {
                                for (const key in bar) {
                                    if (!['time', 'open', 'low', 'high', 'close'].includes(key)) {
                                        if (!window.ssiBuffers[key]) window.ssiBuffers[key] = {};
                                        window.ssiBuffers[key][bar.time] = bar[key];
                                    }
                                }
                            });
                            
                            onHistoryCallback(json.bars, {noData: json.bars.length === 0});
                        } catch (error) {
                            console.error('Failed to load bars:', error);
                            onHistoryCallback([], {noData: true});
                        }
                    },
                    
                    subscribeBars: () => {
                        console.log('Subscribing to bars');
                    },
                    
                    unsubscribeBars: () => {
                        console.log('Unsubscribing from bars');
                    }
                },
                locale: "en",
                disabled_features: ["header_compare", "header_screenshot", "header_saveload"],
                enabled_features: ["dont_show_boolean_study_arguments", "hide_last_na_study_output"],
                custom_indicators_getter: function (_PineJS) {
                    window.PineJS = _PineJS;
                    return Promise.resolve([]);
                },
                charts_storage_url: 'https://saveload.tradingview.com',
                charts_storage_api_version: "1.1",
                client_id: 'tradingview.com',
                user_id: 'public_user_id',
                load_last_chart: true
            });

            widget.headerReady().then(function () {
                console.log('Header ready');
                const resetButton = widget.createButton();
                resetButton.innerHTML = "R";
                resetButton.classList.add('ssi-toggle');
                resetButton.addEventListener('click', function () {
                    console.log('Reset button clicked');
                    if (window.chartDataCache) window.chartDataCache = {};
                    if (window.ssiBuffers) window.ssiBuffers = {};
                    widget.chart().resetData();
                });
                
                // Tambahkan tombol SLC
                const slcButton = widget.createButton();
                slcButton.innerHTML = "SLC";
                slcButton.classList.add('ssi-toggle');
                slcButton.addEventListener('click', function () {
                    console.log('SLC button clicked');
                    initHeatMap();
                });
            });

            widget.onChartReady(function () {
                console.log('Chart ready');
                initHeatMap();
                
                widget.activeChart().onSymbolChanged().subscribe(null, () => {
                    const symbol = widget.activeChart().symbol();
                    console.log('Symbol changed to:', symbol);
                    initHeatMap();
                });
            });

            // ========= FUNGSI UTILITAS =========
            function setURLParameter(name, value) {
                const url = new URL(window.location);
                url.searchParams.set(name, value);
                window.history.replaceState({}, '', url);
            }

            function getURLParameter(name) {
                return new URLSearchParams(window.location.search).get(name);
            }

            // ========= HEATMAP =========
            function initHeatMap() {
                if (!widget || !widget.chart()) {
                    console.log('Widget not ready, retrying in 500ms');
                    setTimeout(initHeatMap, 500);
                    return;
                }
                
                const chart = widget.chart();
                const symbol = chart.symbol();
                console.log('Initializing heatmap for:', symbol);
                
                // Hapus heatmap lama jika ada
                const iframeDoc = document.getElementById(widget._id).contentWindow.document;
                const oldMap = iframeDoc.getElementById('slc');
                if (oldMap) oldMap.remove();
                
                // Buat elemen heatmap baru
                const map = document.createElement("img");
                map.id = "slc";
                map.style.position = "absolute";
                map.style.top = "0";
                map.style.right = "0";
                map.style.zIndex = "100";
                map.style.pointerEvents = "none";
                map.style.opacity = "0.7";
                map.style.display = "block";
                
                // Coba muat heatmap
                const heatmapUrl = `${BASE_URL}/data/heatmap/${symbol}.png`;
                console.log('Loading heatmap from:', heatmapUrl);
                map.src = heatmapUrl;
                
                // Tambahkan ke chart
                const chartContainer = iframeDoc.querySelector('.chart-gui-wrapper');
                if (chartContainer) {
                    chartContainer.appendChild(map);
                    console.log('Heatmap added to chart');
                    adjustHeatmapPosition(map);
                } else {
                    console.log('Chart container not found, retrying in 300ms');
                    setTimeout(() => initHeatMap(), 300);
                }
                
                // Fungsi untuk menyesuaikan posisi heatmap
                function adjustHeatmapPosition(mapElement) {
                    if (!widget || !widget.chart()) return;
                    
                    const chart = widget.chart();
                    const panes = chart.getPanes();
                    if (!panes || !panes[0]) return;
                    
                    try {
                        const priceScale = panes[0].getMainSourcePriceScale();
                        const priceRange = priceScale.getVisiblePriceRange();
                        const paneHeight = panes[0].getHeight();
                        
                        // Ambil data bar terakhir
                        const series = chart.getSeries();
                        const bars = series.data().bars;
                        const lastBar = bars[bars.length - 1];
                        
                        if (lastBar) {
                            // Posisi vertikal berdasarkan harga terakhir
                            const priceDiff = lastBar.close - priceRange.from;
                            const topPosition = paneHeight - (priceDiff / (priceRange.to - priceRange.from)) * paneHeight;
                            
                            // Posisi horizontal di ujung kanan
                            mapElement.style.top = `${topPosition - 50}px`; // Adjust 50px untuk tinggi gambar
                            mapElement.style.right = '0px';
                            mapElement.style.width = '150px';
                            mapElement.style.height = '100px';
                        }
                    } catch (e) {
                        console.error('Error adjusting heatmap position:', e);
                    }
                }
                
                // Sesuaikan posisi secara periodik
                setInterval(() => adjustHeatmapPosition(map), 1000);
            }
        }

        window.addEventListener('DOMContentLoaded', initOnReady, false);
    })();
</script>
</html>
