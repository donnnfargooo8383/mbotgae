<!DOCTYPE HTML>
<html>
<head>
    <title>Cugdeh TradingView Tools</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script type="text/javascript" src="./charting_library.standalone.js"></script>
    <style>
        body { margin: 0; }
        #tv_chart_container { 
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="tv_chart_container"></div>

    <script>
        // Konfigurasi GitHub
        const GITHUB_OWNER = "donnnfargooo8383";
        const GITHUB_REPO = "mbotgae";
        const GITHUB_BRANCH = "main";
        const GITHUB_BASE = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}`;
        
        // Inisialisasi TradingView
        const widget = new TradingView.widget({
            symbol: 'XAUUSD',
            interval: '20',
            container: "tv_chart_container",
            datafeed: {
                onReady: (callback) => {
                    callback({
                        supported_resolutions: ["15", "20", "30", "60", "240"],
                        supports_marks: false,
                        supports_time: true,
                        exchanges: [{ value: 'Cugdeh', name: 'Cugdeh', desc: 'Cugdeh Data' }],
                        symbols_types: [
                            { name: 'crypto', value: 'crypto' },
                            { name: 'forex', value: 'forex' }
                        ]
                    });
                },
                searchSymbols: (userInput, exchange, symbolType, callback) => {
                    const symbols = {
                        crypto: ["BTCUSD"],
                        forex: ["XAUUSD"]
                    };
                    const results = symbols[symbolType]?.map(symbol => ({
                        symbol,
                        ticker: symbol,
                        description: symbol,
                        exchange: "Cugdeh",
                        type: symbolType
                    })) || [];
                    callback(results);
                },
                resolveSymbol: (symbolName, onResolved) => {
                    onResolved({
                        name: symbolName,
                        ticker: symbolName,
                        description: symbolName,
                        type: symbolName === "BTCUSD" ? "crypto" : "forex",
                        session: "24x7",
                        exchange: "Cugdeh",
                        pricescale: 100,
                        minmovement: 1,
                        has_intraday: true,
                        supported_resolutions: ["15", "20", "30", "60", "240"],
                        data_status: "streaming"
                    });
                },
                getBars: async (symbolInfo, resolution, params, onResult) => {
                    const url = `${GITHUB_BASE}/data/history/${symbolInfo.name}_${resolution}.json`;
                    try {
                        const response = await fetch(url);
                        const data = await response.json();

                        console.debug(`[DEBUG] Data loaded:`, {
                            symbol: symbolInfo.name,
                            resolution,
                            barsCount: data.bars?.length || 0
                        });
                        
                        onResult(data.bars, { noData: !data.bars.length });
                    } catch (error) {
                        console.error("Error loading data:", error);
                        onResult([], { noData: true });
                    }
                },
                subscribeBars: () => {},
                unsubscribeBars: () => {}
            },
            library_path: "/charting_library/",
            disabled_features: [
                "header_saveload",
                "header_screenshot",
                "header_compare",
                "timezone_menu",
                "volume_force_overlay",
                "edit_buttons_in_legend",
                "context_menus",
                "control_bar",
                "save_chart_properties_to_local_storage",
                "load_chart_properties_from_local_storage"
            ],
            enabled_features: [
                "study_templates",
                "dont_show_boolean_study_arguments",
                "hide_last_na_study_output",
                "use_localstorage_for_settings"
            ],
            // charts_storage_url: "https://saveload.tradingview.com",
            // charts_storage_api_version: "1.1",
            // client_id: "tradingview.com",
            // user_id: "public_user",
            fullscreen: true,
            autosize: true,
            studies_overrides: {},
            // custom_css_url: "/mbotgae/tv.css",
            locale: "en",
            studies_overrides: {
                "volume.volume.color.0": "#FF0000",
                "volume.volume.color.1": "#00FF00"
            }
        });

        // Inisialisasi Heatmap
        widget.onChartReady(() => {
            const chart = widget.chart();
            chart.createStudy('Moving Average', false, false, [10], null, { 'Plot.color': '#FF0000' });
            
            // Tambahkan heatmap
            const heatmapImg = document.createElement('img');
            heatmapImg.id = 'heatmap-overlay';
            heatmapImg.style.position = 'absolute';
            heatmapImg.style.zIndex = '10';
            heatmapImg.style.pointerEvents = 'none';
            heatmapImg.style.mixBlendMode = 'multiply';
            document.querySelector('.chart-gui-wrapper').appendChild(heatmapImg);
            
            function updateHeatmap() {
                const symbol = chart.getSymbol();
                heatmapImg.src = `${GITHUB_BASE}/data/heatmap/${symbol}.svg?t=${Date.now()}`;
                heatmapImg.style.width = '100%';
                heatmapImg.style.height = '100%';
            }
            
            chart.onSymbolChanged().subscribe(null, updateHeatmap);
            updateHeatmap();
        });
    </script>
</body>
</html>
