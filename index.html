<!DOCTYPE HTML>
<html>
<head>
    <title>Jancok Tools - FXSSI</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <script type="text/javascript" src="./charting_library.standalone.js"></script>
    <script type="text/javascript" src="./bundle.js"></script>
    <link rel="stylesheet" href="./wrpskc.css?v=3">
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-size: 20px;
            flex-direction: column;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body style="margin:0;">
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div>Memuat data dari GitHub...</div>
    </div>
    
    <div id="workspace" class="with-book o p">
        <div id="tv_chart_container"></div>
        <div id="right_panel" class="_loading">
            <div class="toolbar">
                <div class="op-toggle toolbar-btn o p">
                    Orders + Positions
                </div>
                <div class="net-toggle toolbar-btn">
                    All
                </div>
            </div>
            <div class="books"></div>
            <div class="suspended-message">suspended...</div>
            <div class="suspended-overlay"></div>
            <div class="price-line"></div>
            <div class="book-price-line"></div>
        </div>
    </div>
    
    <script type="text/javascript">
        // ======== FUNGSI UTAMA YANG DIPINDAHKAN ========
        function getURLParameter(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        (function () {
            // Konfigurasi GitHub
            const GITHUB_OWNER = "donnnfargooo8383";
            const GITHUB_REPO = "mbotgae";
            const GITHUB_BRANCH = "main";
            
            // URL dasar untuk data di GitHub
            const GITHUB_DATA_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/data`;
            
            // Variabel untuk menyimpan data dari GitHub
            window.githubData = {
                history: {},
                heatmap: {}
            };
            
            // Menampilkan/menyembunyikan loading overlay
            function showLoading(show) {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.style.display = show ? 'flex' : 'none';
                }
            }
            
            // Fungsi untuk mengambil data dari GitHub
            async function fetchFromGitHub(path) {
                try {
                    const url = `${GITHUB_DATA_BASE_URL}/${path}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`Gagal mengambil data: ${response.status}`);
                    }
                    
                    // Handle JSON vs binary data
                    if (path.endsWith('.json')) {
                        return await response.json();
                    } else {
                        return await response.blob();
                    }
                } catch (error) {
                    console.error(`Error mengambil data dari GitHub: ${error.message}`);
                    return null;
                }
            }
            
            // Fungsi untuk mengambil data history
            async function loadHistoryData(symbol, resolution) {
                const cacheKey = `${symbol}_${resolution}`;
                
                // Gunakan data cache jika tersedia
                if (window.githubData.history[cacheKey]) {
                    return window.githubData.history[cacheKey];
                }
                
                showLoading(true);
                const path = `history/${symbol}_${resolution}.json`;
                const data = await fetchFromGitHub(path);
                
                if (data) {
                    window.githubData.history[cacheKey] = data;
                    console.log(`Data history ${symbol} ${resolution}m berhasil dimuat`);
                } else {
                    console.error(`Data history ${symbol} ${resolution}m tidak ditemukan`);
                }
                
                showLoading(false);
                return data;
            }
            
            // Fungsi untuk mengambil heatmap
            async function loadHeatmapData(symbol) {
                // Gunakan data cache jika tersedia
                if (window.githubData.heatmap[symbol]) {
                    return window.githubData.heatmap[symbol];
                }
                
                showLoading(true);
                const path = `heatmap/${symbol}.png`;
                const blob = await fetchFromGitHub(path);
                
                if (blob) {
                    // Konversi blob ke URL objek
                    const url = URL.createObjectURL(blob);
                    window.githubData.heatmap[symbol] = url;
                    console.log(`Heatmap ${symbol} berhasil dimuat`);
                } else {
                    console.error(`Heatmap ${symbol} tidak ditemukan`);
                }
                
                showLoading(false);
                return window.githubData.heatmap[symbol];
            }

            window.user = {
                host: "fxssi.com",
                id: 30747,
                name: "Try it FREE",
                "plan-pro": true,
                plan: "proplus",
                avatar: "/anonymous.png"
            };
            
            // ======== INISIALISASI CHART ========
            function initOnReady() {
                const widget = new TradingView.widget({
                    fullscreen: true,
                    symbol: getURLParameter('symbol') || 'XAUUSD',
                    interval: '20',
                    container: "tv_chart_container",
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    save_load_adapter: {
                        getAllCharts: function () {
                            return Promise.resolve({
                                id: "main_chart",
                                name: "main_chart",
                                resolution: "15M",
                                symbol: "XAUUSD"
                            });
                        }
                    },
                    datafeed: {
                        onReady: (callback) => {
                            callback({
                                supported_resolutions: ["15", "20", "30", "60", "240"],
                                supports_marks: true,
                                supports_search: true,
                                supports_time: true,
                                exchanges: [{
                                    value: 'FXSSI',
                                    name: 'FXSSI',
                                    desc: 'FXSSI.com'
                                }],
                                symbols_types: [{
                                        name: 'crypto',
                                        value: 'crypto'
                                    },
                                    {
                                        name: 'forex',
                                        value: 'forex'
                                    },
                                    {
                                        name: 'index',
                                        value: 'index'
                                    },
                                ]
                            });
                        },
                        searchSymbols: (userInput, exchange, symbolType, onResultReadyCallback) => {
                            let symbols;
                            const crypto = [
                                "BTCUSD"
                            ];
                            const forex = [
                                "XAUUSD"
                            ];
                            const indexes = [
                                "US30"
                            ];
                            
                            if (symbolType === 'crypto') {
                                symbols = crypto;
                            } else if (symbolType === 'forex') {
                                symbols = forex;
                            } else if (symbolType === 'index') {
                                symbols = indexes;
                            } else {
                                symbols = [...crypto, ...forex];
                            }

                            const ret = symbols
                                .filter(symbol => symbol.toLowerCase().includes(userInput.toLowerCase()))
                                .map(symbol => {
                                    let type = "forex";
                                    if (crypto.includes(symbol)) type = 'crypto';
                                    if (indexes.includes(symbol)) type = 'index';
                                    
                                    return {
                                        symbol: symbol,
                                        ticker: symbol,
                                        description: symbol,
                                        exchange: "FXSSI",
                                        type: type
                                    };
                                });

                            onResultReadyCallback(ret);
                        },
                        resolveSymbol: (symbolName, onSymbolResolvedCallback) => {
                            let type = "forex";
                            if (['ETHUSD', 'BTCUSD'].includes(symbolName)) type = 'crypto';
                            if (['US30', 'NAS100'].includes(symbolName)) type = 'index';
                            
                            let session = "2200-2200";
                            if (type === 'crypto') session = '24x7';
                            if (symbolName === "XTIUSD") session = '2200-2100';

                            onSymbolResolvedCallback({
                                name: symbolName,
                                ticker: symbolName,
                                description: symbolName,
                                type: type,
                                session: session,
                                exchange: "FXSSI",
                                listed_exchange: "",
                                minmovement: 1,
                                pricescale: 10000,
                                pointvalue: 100,
                                minmovement2: 100,
                                fractional: false,
                                has_intraday: true,
                                has_seconds: false,
                                seconds_multipliers: [],
                                has_daily: true,
                                has_weekly_and_monthly: true,
                                has_empty_bars: true,
                                force_session_rebuild: true,
                                visible_plots_set: "ohlc",
                                volume_precision: 1,
                                data_status: "streaming",
                                expired: false,
                                sector: "",
                                industry: ""
                            });
                        },
                        getBars: async function(symbolInfo, resolution, periodParams, onHistoryCallback) {
                            const symbol = symbolInfo.name;
                            try {
                                const historyData = await loadHistoryData(symbol, resolution);
                                
                                if (!historyData || !historyData.bars) {
                                    onHistoryCallback([], { noData: true });
                                    return;
                                }
                                
                                window.ssiBuffers = window.ssiBuffers || {};
                                historyData.bars.forEach(bar => {
                                    for (const [key, value] of Object.entries(bar)) {
                                        if (!['time', 'open', 'low', 'high', 'close'].includes(key)) {
                                            window.ssiBuffers[key] = window.ssiBuffers[key] || {};
                                            window.ssiBuffers[key][bar.time] = value;
                                        }
                                    }
                                });
                                
                                onHistoryCallback(historyData.bars, { noData: false });
                            } catch (error) {
                                console.error(`Error in getBars: ${error}`);
                                onHistoryCallback([], { noData: true });
                            }
                        },
                        subscribeBars: () => {}, // Dummy function
                        unsubscribeBars: () => {} // Dummy function
                    },
                    locale: "en",
                    disabled_features: ["header_compare", "header_screenshot", "header_saveload"],
                    custom_indicators_getter: function(PineJS) {
                        window.PineJS = PineJS;
                        return Promise.resolve([                            
                            __prorat_buy_sell__, __prorat_signal__, __prorat_delta__,
                            __interest_orders__, __interest_orders_delta__, __interest_positions__, __interest_positions_delta__,
                            __activity_increase__, __activity_increase_delta__, __activity_decrease__, __activity_decrease_delta__,
                            __ratios__, __derivatives__
                            ]);
                    }
                });

                // ======== HEATMAP IMPROVED ========
                async function initHeatMap() {
                    const chart = widget.chart();
                    let map = null;

                    async function setupHeatmap() {
                        const symbol = chart.symbol();
                        const heatmapUrl = await loadHeatmapData(symbol);
                        if (!heatmapUrl) return;

                        // Hapus heatmap lama jika ada
                        const container = document.querySelector(".pane .chart-gui-wrapper");
                        const oldMap = container.querySelector("#slc");
                        if (oldMap) oldMap.remove();

                        // Buat heatmap baru
                        map = document.createElement("img");
                        map.id = "slc";
                        map.style.cssText = `
                            width: 300px;
                            position: absolute;
                            top: 0;
                            right: 0;
                            cursor: pointer;
                            pointer-events: none;
                            mix-blend-mode: darken;
                            z-index: 100;
                        `;
                        map.src = heatmapUrl;
                        container.appendChild(map);
                    }

                    // Setup awal
                    setupHeatmap();

                    // Update saat simbol berubah
                    chart.onSymbolChanged().subscribe(null, setupHeatmap);
                }

                // ======== INITIAL SETUP ========
                widget.onChartReady(() => {
                    console.log("Chart Ready");
                    initHeatMap();
                    
                    widget.activeChart().onSymbolChanged().subscribe(null, () => {
                        const urlParams = new URLSearchParams(window.location.search);
                        urlParams.set('symbol', widget.activeChart().symbol());
                        window.history.replaceState({}, '', `?${urlParams}`);
                    });
                });
            }

            // ======== START APPLICATION ========
            window.addEventListener('DOMContentLoaded', () => {
                // Cek dukungan browser
                if (typeof TradingView === 'undefined') {
                    alert('Error: Charting library not loaded!');
                    return;
                }
                
                // Inisialisasi aplikasi
                try {
                    initOnReady();
                } catch (error) {
                    console.error('Application init error:', error);
                    showLoading(false);
                    alert('Terjadi kesalahan saat memulai aplikasi. Silakan coba lagi.');
                }
            });
        })();
    </script>
</body>
</html>
