<!DOCTYPE HTML>
<html>
<head>
    <title>TradingView Tools</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <script type="text/javascript" src="./charting_library.standalone.js"></script>
    <script type="text/javascript" src="./bundle.js"></script>
    <link rel="stylesheet" href="./wrpskc.css?v=3">
</head>
<body style="margin:0;">
<div id="workspace" class="with-book o p">
    <div id="tv_chart_container"></div>
    <div id="right_panel" class="_loading">
        <div class="toolbar">
            <div class="op-toggle toolbar-btn o p">Orders + Positions</div>
            <div class="net-toggle">All</div>
        </div>
        <div class="books"></div>
        <div class="suspended-message">suspended...</div>
        <div class="suspended-overlay"></div>
        <div class="price-line"></div>
        <div class="book-price-line"></div>
    </div>
</div>
</body>
<script type="text/javascript">
    (function () {
        // ======== KONFIGURASI GITHUB ========
        const GITHUB_OWNER = "donnnfargooo8383";
        const GITHUB_REPO = "mbotgae";
        const GITHUB_BRANCH = "main";
        
        // Base URL untuk data GitHub
        const GITHUB_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}`;
        
        // ======== KONFIGURASI UTAMA ========
        window.user = {
            host: "fxssi.com",
            id: 30747,
            name: "Try it FREE",
            "plan-pro": true,
            plan: "proplus",
            avatar: "https://fxssi.com/images/anonymous.png",
            version: 25,
            userAgent: navigator.userAgent ?? '?',
            platform: navigator.platform ?? '?'
        };

        // ... [Kode indikator tetap sama] ...

        function initOnReady() {
            // HAPUS SEMUA KODE TERKAIT WEBSOCKET
            // ======== INISIALISASI CHART ========
            const widget = new TradingView.widget({
                fullscreen: true,
                symbol: getURLParameter('symbol') ?? 'EURUSD',
                interval: '20',
                container: "tv_chart_container",
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                datafeed: {
                    onReady: (callback) => {
                        callback({
                            supported_resolutions: ["15", "20", "30", "60", "240"],
                            supports_marks: true,
                            supports_search: true,
                            supports_time: true,
                            exchanges: [
                                {value: 'FXSSI', name: 'FXSSI', desc: 'FXSSI.com'},
                            ],
                            symbols_types: [
                                {name: 'crypto', value: 'crypto'},
                                {name: 'forex', value: 'forex'},
                                {name: 'index', value: 'index'},
                            ]
                        });
                    },
                    searchSymbols: (userInput, exchange, symbolType, onResultReadyCallback) => {
                        let symbols;
                        const crypto = [
                            "BTCUSD",
                            "ETHUSD",
                        ];
                        const forex = [
                            "EURUSD",
                            "XAUUSD",
                            "EURGBP",
                            "AUDJPY",
                            "AUDUSD",
                            "EURAUD",
                            "EURCHF",
                            "EURJPY",
                            "GBPCHF",
                            "GBPJPY",
                            "GBPUSD",
                            "NZDUSD",
                            "USDCAD",
                            "USDCHF",
                            "USDJPY",
                            "XAGUSD",
                            "XTIUSD"
                        ];
                        const indexes = [
                            "US30",
                            "NAS100"
                        ];
                        if (symbolType === 'crypto')
                            symbols = crypto;
                        else if (symbolType === 'forex')
                            symbols = forex;
                        else if (symbolType === 'index')
                            symbols = indexes;
                        else
                            symbols = crypto.concat(forex);

                        let ret = [];
                        let found_symbols = [];
                        for (let symbol of symbols) {
                            if (['ETHUSD', 'BTCUSD'].indexOf(symbol) > -1) symbolType = 'crypto';
                            if (['US30', 'NAS100'].indexOf(symbol) > -1) symbolType = 'index';
                            if (symbol.toLowerCase().indexOf(userInput.toLowerCase()) < 0) continue;
                            found_symbols.push(symbol);
                        }
                        symbols = found_symbols.concat(symbols);
                        symbols = symbols.filter((value, index, array) => array.indexOf(value) === index);

                        for (let symbol of symbols) {
                            // type = "forex";
                            ret.push({
                                "symbol": symbol,
                                "ticker": symbol,
                                // "full_name": symbol,
                                "description": symbol,
                                "exchange": "FXSSI",
                                "type": symbolType
                            });
                        }

                        onResultReadyCallback(ret);
                    },
                    
                    resolveSymbol: (symbolName, onSymbolResolvedCallback, onResolveErrorCallback, extension) => {
                        // console.log('[resolveSymbol]: Method call', symbolName);
                        let type = "forex";
                        if (['ETHUSD', 'BTCUSD'].indexOf(symbolName) > -1) type = 'crypto';
                        if (['US30', 'NAS100'].indexOf(symbolName) > -1) type = 'index';
                        let session = "2200-2200";
                        if (type === 'crypto') session = '24x7';
                        if (symbolName === "XTIUSD") session = '2200-2100';

                        const config = {
                            "name": symbolName,
                            "ticker": symbolName,
                            "description": symbolName,
                            "type": type,
                            "session": session,
                            "exchange": "FXSSI",
                            "listed_exchange": "",
                            "minmovement": 1,
                            "pricescale": 10000,
                            "pointvalue": 100,
                            "minmovement2": 100,
                            "fractional": false,
                            // "suported_resolutions": [
                            //     "5",
                            //     "15",
                            //     "30",
                            //     "60",
                            //     "240",
                            // ],
                            "has_intraday": true,
                            // "intraday_multipliers": [
                            //     "5",
                            //     "15",
                            //     "30",
                            //     "60",
                            //     "240",
                            // ],
                            "has_seconds": false,
                            "seconds_multipliers": [],
                            "has_daily": true,
                            "has_weekly_and_monthly": true,
                            "has_empty_bars": true,
                            "force_session_rebuild": true,
                            "visible_plots_set": "ohlc",
                            "volume_precision": 1,
                            "data_status": "streaming",
                            "expired": false,
                            "sector": "",
                            "industry": ""
            //                    "currency_code": "EURUSD"
                        }

                        // console.log(config);
                        onSymbolResolvedCallback(config);
                    },
                        
                    getBars: async function (symbolInfo, resolution, periodParams, onHistoryCallback, onErrorCallback) {
                        const symbol = symbolInfo.name;
                        const historyUrl = `${GITHUB_BASE_URL}/data/history/${symbol}_${resolution}.json`;
                        
                        try {
                            const response = await fetch(historyUrl);
                            if (!response.ok) throw new Error('Data tidak ditemukan');
                            
                            const json = await response.json();
                            
                            // Proses data history
                            for (let bar of json.bars) {
                                for (let key in bar) {
                                    if (['time', 'open', 'low', 'high', 'close'].includes(key)) continue;
                                    
                                    if (!window.ssiBuffers) window.ssiBuffers = {};
                                    if (!window.ssiBuffers[key]) window.ssiBuffers[key] = {};
                                    window.ssiBuffers[key][bar['time']] = bar[key];
                                }
                            }
                            
                            // Panggil callback dengan data
                            onHistoryCallback(json.bars, {noData: json.bars.length === 0});
                        } catch (error) {
                            console.error('Gagal mengambil data history:', error);
                            onHistoryCallback([], {noData: true});
                        }
                    },
                    subscribeBars: () => {}, // Kosongkan karena tidak realtime
                    unsubscribeBars: () => {} // Kosongkan karena tidak realtime
                },
                locale: "en",
                disabled_features: ["header_compare", "header_screenshot", "header_saveload"],
                custom_indicators_getter: function (_PineJS) {
                    window.PineJS = _PineJS;
                    return Promise.resolve([
                        // ... [Daftar indikator tetap sama] ...
                        __prorat_buy_sell__, __prorat_signal__, __prorat_delta__,
                        __interest_orders__, __interest_orders_delta__, __interest_positions__, __interest_positions_delta__,
                        __activity_increase__, __activity_increase_delta__, __activity_decrease__, __activity_decrease_delta__,
                        __ratios__, __derivatives__
                    ]);
                }
            });

            // ======== FUNGSI HEATMAP ========
            widget.heatmap = {};

            function initHeatMap() {
                const chart = widget.chart();
                let map = null;

                function updateHeatMap(symbol) {
                    if (!map) {
                        map = document.createElement("img");
                        map.id = "slc";
                        map.style.cssText = `
                            position: absolute;
                            top: 0; 
                            right: 0;
                            cursor: pointer;
                            pointer-events: none;
                            mix-blend-mode: darken;
                            display: none;
                        `;
                        document.getElementById(widget._id).contentWindow.document
                            .querySelector(".pane .chart-gui-wrapper")
                            .appendChild(map);
                    }

                    // Ambil heatmap dari GitHub
                    map.src = `${GITHUB_BASE_URL}/data/heatmap/${symbol}.png?t=${Date.now()}`;
                    map.style.display = 'block';
                }

                chart.onSymbolChanged().subscribe(null, () => {
                    updateHeatMap(chart.symbol());
                });

                // Tombol toggle heatmap
                widget.headerReady().then(() => {
                    const button = widget.createButton();
                    button.classList.add('ssi-toggle', 'active');
                    button.textContent = 'SLC';
                    button.addEventListener('click', () => {
                        button.classList.toggle('active');
                        if (map) map.style.display = button.classList.contains('active') 
                            ? 'block' : 'none';
                    });
                });

                // Inisialisasi pertama
                updateHeatMap(chart.symbol());
            }

            // ======== FUNGSI ORDER BOOK ========
            function initBook() {
                // ... [Implementasi order book tetap sama] ...
                // CATATAN: Bagian ini memerlukan penyesuaian serupa jika ingin mengambil data dari GitHub
            }

            // ======== INISIALISASI KOMPONEN ========
            widget.headerReady().then(() => {
                // Tombol toggle order book
                const bookButton = widget.createButton();
                bookButton.classList.add('ssi-toggle', 'active');
                bookButton.textContent = 'OrderBook';
                bookButton.addEventListener('click', () => {
                    document.getElementById('workspace').classList.toggle('with-book');
                });
            });

            widget.onChartReady(() => {
                initBook();
                initHeatMap();
                
                // ... [Kode indikator dan dropdown tetap sama] ...
            });
        }

        window.addEventListener('DOMContentLoaded', initOnReady, false);
    })();

    // ======== FUNGSI UTILITAS ========
    function setURLParameter($name, $value, $url) {
        // ... [Implementasi tetap sama] ...
    }

    function getURLParameter(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
        const results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
</script>
</html>
