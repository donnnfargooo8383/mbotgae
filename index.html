<!DOCTYPE HTML>
<html>
<head>
    <title>TradingView Tools - FXSSI</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <script type="text/javascript" src="./charting_library.standalone.js"></script>
    <script type="text/javascript" src="./bundle.js"></script>
    <link rel="stylesheet" href="./wrpskc.css?v=3">
</head>
<body style="margin:0;">
<div id="tv_chart_container" style="width:100%; height:100vh;"></div>
</body>
<script type="text/javascript">
    (function () {
        // ======= KONFIGURASI GITHUB ========
        const GITHUB_OWNER = "donnnfargooo8383";
        const GITHUB_REPO = "tradingview-tools";
        const GITHUB_BRANCH = "main";
        const GITHUB_DATA_BASE = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/data`;

        window.user = {
            "host": "fxssi.com",
            "id": 30747,
            "name": "Try it FREE",
            "plan-pro": true,
            "plan": "proplus",
            "avatar": "https://fxssi.com/images/anonymous.png"
        };
        
        // ======= STUDI KUSTOM UNTUK TRADINGVIEW ========
        // [Semua definisi studi kustom tetap sama seperti aslinya]
        // ... (semua definisi indikator __prorat_buy_sell__ hingga __derivatives__)

        function initOnReady() {
            // ======= FUNGSI UTILITAS ========
            function getURLParameter(name, url) {
                if (!url) url = location.href;
                name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
                var regexS = "[\\?&]" + name + "=([^&#]*)";
                var regex = new RegExp(regexS);
                var results = regex.exec(url);
                return results == null ? undefined : results[1];
            }

            // ======= DATA FEED YANG DIMODIFIKASI ========
            const widget = new TradingView.widget({
                fullscreen: true,
                symbol: getURLParameter('symbol') ?? 'EURUSD',
                interval: '20',
                container: "tv_chart_container",
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                datafeed: {
                    onReady: (callback) => {
                        callback({
                            supported_resolutions: ["15", "20", "30", "60", "240"],
                            supports_marks: true,
                            supports_search: true,
                            supports_time: true,
                            exchanges: [
                                {value: 'FXSSI', name: 'FXSSI', desc: 'FXSSI.com'},
                            ],
                            symbols_types: [
                                {name: 'crypto', value: 'crypto'},
                                {name: 'forex', value: 'forex'},
                                {name: 'index', value: 'index'},
                            ]
                        });
                    },
                    searchSymbols: (userInput, exchange, symbolType, onResultReadyCallback) => {
                        // ... (implementasi pencarian simbol tetap sama)
                    },
                    resolveSymbol: (symbolName, onSymbolResolvedCallback, onResolveErrorCallback, extension) => {
                        // ... (implementasi resolusi simbol tetap sama)
                    },
                    getBars: async function (symbolInfo, resolution, periodParams, onHistoryCallback, onErrorCallback) {
                        const url = `${GITHUB_DATA_BASE}/history/${symbolInfo.name}_${resolution}.json`;
                        
                        try {
                            const response = await fetch(url);
                            const json = await response.json();
                            
                            // Proses data dan simpan di buffer
                            for (let bar of json.bars) {
                                for (let key in bar) {
                                    if (['time', 'open', 'low', 'high', 'close'].indexOf(key) < 0) {
                                        if (!window.ssiBuffers) window.ssiBuffers = {};
                                        if (!window.ssiBuffers[key]) window.ssiBuffers[key] = {};
                                        window.ssiBuffers[key][bar['time']] = bar[key];
                                    }
                                }
                            }
                            
                            onHistoryCallback(json.bars);
                        } catch (error) {
                            console.error(`Failed to load data for ${symbolInfo.name} at ${resolution}:`, error);
                            onHistoryCallback([], {noData: true});
                        }
                    },
                    subscribeBars: () => {}, // Kosongkan karena tidak real-time
                    unsubscribeBars: () => {} // Kosongkan karena tidak real-time
                },
                locale: "en",
                disabled_features: ["header_compare", "header_screenshot", "header_saveload"],
                custom_indicators_getter: function (PineJS) {
                    window.PineJS = PineJS;
                    return Promise.resolve([
                        __prorat_buy_sell__, __prorat_signal__, __prorat_delta__,
                        __interest_orders__, __interest_orders_delta__, __interest_positions__, __interest_positions_delta__,
                        __activity_increase__, __activity_increase_delta__, __activity_decrease__, __activity_decrease_delta__,
                        __ratios__, __derivatives__
                    ]);
                }
            });

            // ======= FUNGSI HEATMAP YANG DIMODIFIKASI ========
            function initHeatMap() {
                const chart = widget.chart();
                let map = null;
                let symbol = chart.symbol();

                function createHeatMap() {
                    if (!chart.getSeries()) return false;
                    
                    symbol = chart.symbol();
                    map = document.createElement("img");
                    map.id = "slc";
                    map.style.cssText = `
                        position: absolute;
                        top: 0;
                        right: 0;
                        cursor: pointer;
                        pointer-events: none;
                        mix-blend-mode: darken;
                    `;
                    
                    map.src = `${GITHUB_DATA_BASE}/heatmap/${symbol}.png`;
                    document.querySelector(".pane .chart-gui-wrapper").appendChild(map);
                    return true;
                }

                widget.headerReady().then(function () {
                    const button = widget.createButton();
                    button.classList.add('ssi-toggle', 'active');
                    button.textContent = 'SLC';
                    button.addEventListener('click', function() {
                        button.classList.toggle('active');
                        if (map) map.style.visibility = button.classList.contains('active') 
                            ? 'visible' : 'hidden';
                    });
                });
                
                createHeatMap();
            }

            // ======= INISIALISASI WIDGET ========
            widget.onChartReady(function () {
                initHeatMap();
                
                widget.createDropdown({
                    title: 'FXSSI Indicators',
                    // ... (item dropdown tetap sama)
                });
            });
        }

        window.addEventListener('DOMContentLoaded', initOnReady, false);
    })();
</script>
</html>
